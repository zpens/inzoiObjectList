<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>inZOI Object Catalog</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&family=Space+Mono:wght@400;700&display=swap');

:root {
  --bg-primary: #0a0a0f;
  --bg-secondary: #12121a;
  --bg-card: #1a1a26;
  --bg-hover: #222235;
  --accent: #6c5ce7;
  --accent-light: #a29bfe;
  --accent-glow: rgba(108, 92, 231, 0.3);
  --text-primary: #e8e6f0;
  --text-secondary: #8b8a9e;
  --text-muted: #5a5970;
  --border: #2a2a3d;
  --success: #00cec9;
  --warning: #fdcb6e;
  --danger: #ff7675;
}

:root[data-theme="light"] {
  --bg-primary: #f5f5f8;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --bg-hover: #eeeef2;
  --accent: #6c5ce7;
  --accent-light: #5a4bd1;
  --accent-glow: rgba(108, 92, 231, 0.15);
  --text-primary: #1a1a2e;
  --text-secondary: #555568;
  --text-muted: #8888a0;
  --border: #dddde5;
  --success: #00a89e;
  --warning: #e0a800;
  --danger: #e05555;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow: hidden;
  height: 100vh;
}

.header {
  height: 64px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 24px;
  gap: 20px;
  position: relative;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}
.logo img { height: 22px; display: block; }
.logo span {
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--text-secondary);
}

.search-box { flex: 1; max-width: 480px; position: relative; }
.search-box input {
  width: 100%; padding: 10px 16px 10px 42px;
  background: var(--bg-primary); border: 1px solid var(--border);
  border-radius: 10px; color: var(--text-primary); font-size: 14px;
  font-family: inherit; outline: none; transition: border-color 0.2s, box-shadow 0.2s;
}
.search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
.search-box input::placeholder { color: var(--text-muted); }
.search-box::before { content: "\1F50D"; position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 16px; opacity: 0.5; }

.stats { font-size: 13px; color: var(--text-secondary); white-space: nowrap; font-family: 'Space Mono', monospace; }
.stats b { color: var(--accent-light); }

.view-modes { display: flex; gap: 4px; background: var(--bg-primary); padding: 3px; border-radius: 10px; }
.view-btn {
  padding: 7px 16px; border: none; background: transparent; color: var(--text-muted);
  font-size: 13px; font-family: inherit; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.view-btn:hover { color: var(--text-secondary); }
.view-btn.active { background: var(--accent); color: white; box-shadow: 0 2px 10px var(--accent-glow); }

.theme-toggle {
  width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--border);
  background: var(--bg-primary); color: var(--text-secondary); font-size: 16px;
  cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.theme-toggle:hover { border-color: var(--accent); color: var(--accent-light); }

.app-body { display: flex; height: calc(100vh - 64px); }

.sidebar {
  width: 260px; min-width: 260px; background: var(--bg-secondary);
  border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden;
}
.sidebar-title-row { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px 12px; }
.sidebar-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); }
.lang-toggle {
  padding: 3px 10px; border: 1px solid var(--border); background: var(--bg-primary);
  color: var(--accent-light); font-size: 11px; font-family: 'Space Mono', monospace;
  font-weight: 700; border-radius: 6px; cursor: pointer; transition: all 0.2s;
}
.lang-toggle:hover { border-color: var(--accent); background: rgba(108,92,231,0.1); }
.lang-toggle.ko { background: var(--accent); color: white; border-color: var(--accent); }

.sidebar-search { padding: 0 12px 12px; }
.sidebar-search input {
  width: 100%; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text-primary); font-size: 12px; font-family: inherit; outline: none;
}
.sidebar-search input:focus { border-color: var(--accent); }

.filter-list { flex: 1; overflow-y: auto; padding: 0 8px 16px; }
.filter-list::-webkit-scrollbar { width: 4px; }
.filter-list::-webkit-scrollbar-track { background: transparent; }
.filter-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.filter-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.15s;
  font-size: 13px; color: var(--text-secondary);
}
.filter-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.filter-item.active { background: rgba(108, 92, 231, 0.15); color: var(--accent-light); }
.filter-item .count {
  font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-muted);
  background: var(--bg-primary); padding: 2px 8px; border-radius: 10px;
}
.filter-item.active .count { background: rgba(108, 92, 231, 0.25); color: var(--accent-light); }
.filter-item.lv1 { font-size: 14px; font-weight: 800; color: var(--text-primary); padding: 10px 12px; margin-top: 6px; letter-spacing: -0.3px; border-bottom: 1px solid var(--border); border-radius: 8px 8px 0 0; }
.filter-item.lv1 .count { font-size: 11px; font-weight: 400; }
.filter-item.lv2 { font-size: 13px; font-weight: 600; color: var(--text-secondary); padding: 7px 12px 7px 22px; }
.filter-item.lv3 { font-size: 11px; font-weight: 400; color: var(--text-muted); padding: 5px 12px 5px 38px; }

.sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.sidebar-tab {
  flex: 1; padding: 10px 0; text-align: center; font-size: 12px; font-weight: 600;
  color: var(--text-muted); cursor: pointer; border: none; background: none;
  border-bottom: 2px solid transparent; transition: all 0.15s; font-family: inherit;
}
.sidebar-tab:hover { color: var(--text-secondary); }
.sidebar-tab.active { color: var(--accent-light); border-bottom-color: var(--accent); }
.sidebar-panel { display: none; flex: 1; overflow-y: auto; padding: 0 8px 16px; flex-direction: column; }
.sidebar-panel.active { display: flex; }
.sidebar-panel::-webkit-scrollbar { width: 4px; }
.sidebar-panel::-webkit-scrollbar-track { background: transparent; }
.sidebar-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
.filter-group { margin-top: 8px; }
.filter-group-title {
  font-size: 12px; font-weight: 700; color: var(--text-muted); padding: 8px 12px 4px;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.filter-tag-btn {
  display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; margin: 3px;
  border: 1px solid var(--border); border-radius: 16px; background: var(--bg-primary);
  color: var(--text-secondary); font-size: 11px; font-family: inherit; cursor: pointer;
  transition: all 0.15s;
}
.filter-tag-btn:hover { border-color: var(--accent); color: var(--text-primary); }
.filter-tag-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
.filter-tag-btn.disabled { opacity: 0.35; cursor: default; }
.filter-tag-btn .tag-count { font-family: 'Space Mono', monospace; font-size: 10px; opacity: 0.7; }

.main-content { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
.main-content::-webkit-scrollbar { width: 6px; }
.main-content::-webkit-scrollbar-track { background: transparent; }
.main-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 6px; }

.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
.grid-view.large { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }

.size-toggle { display: flex; gap: 4px; background: var(--bg-primary); padding: 3px; border-radius: 8px; margin-left: auto; }
.size-btn {
  padding: 6px 14px; border: none; background: transparent; color: var(--text-muted);
  font-size: 12px; font-family: inherit; font-weight: 500; border-radius: 6px; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.size-btn:hover { color: var(--text-secondary); }
.size-btn.active { background: var(--accent); color: white; }

.card {
  background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border);
  overflow: hidden; cursor: pointer; transition: all 0.25s ease; position: relative;
}
.card:hover { transform: translateY(-4px); border-color: var(--accent); box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px var(--accent-glow); }
.card-img { width: 100%; aspect-ratio: 1; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; overflow: hidden; }
.card-img img { width: 80%; height: 80%; object-fit: contain; transition: transform 0.3s; }
.card:hover .card-img img { transform: scale(1.1); }
.card-img .placeholder { font-size: 36px; opacity: 0.15; }
.card-info { padding: 10px 12px; }
.card-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
.card-meta { display: flex; justify-content: space-between; align-items: center; }
.card-filter { font-size: 10px; color: var(--text-muted); background: var(--bg-primary); padding: 2px 6px; border-radius: 4px; max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card-path { font-size: 9px; color: var(--text-muted); opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.grid-view.large .card-path { font-size: 10px; }
.card-price { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--success); font-weight: 700; }

.grid-view.large .card-img img { width: 85%; height: 85%; }
.grid-view.large .card-info { padding: 14px 16px; }
.grid-view.large .card-name { font-size: 15px; }
.grid-view.large .card-filter { font-size: 11px; max-width: 140px; }
.grid-view.large .card-price { font-size: 14px; }
.category-grid.large { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }
.category-grid.large .card-img img { width: 85%; height: 85%; }
.category-grid.large .card-info { padding: 14px 16px; }
.category-grid.large .card-name { font-size: 15px; }

.category-view {}
.category-section { margin-bottom: 32px; }
.category-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.category-name { font-size: 18px; font-weight: 700; }
.category-count { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--accent-light); background: rgba(108, 92, 231, 0.15); padding: 4px 10px; border-radius: 20px; }
.category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }

.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
  z-index: 1000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s;
}
.modal-overlay.show { display: flex; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 20px; width: 90%; max-width: 520px; overflow: hidden; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-img { width: 100%; height: 300px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; }
.modal-img img { max-width: 85%; max-height: 85%; object-fit: contain; }
.modal-body { padding: 24px; }
.modal-name { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
.modal-id { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--text-muted); margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
.modal-id .copy-btn { background: none; border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); cursor: pointer; font-size: 11px; padding: 2px 6px; transition: all 0.15s; }
.modal-id .copy-btn:hover { border-color: var(--accent); color: var(--accent-light); }
.modal-id .copy-btn.copied { border-color: var(--success); color: var(--success); }
.modal-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 16px; }
.modal-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
.modal-tag { font-size: 11px; padding: 4px 10px; border-radius: 6px; background: rgba(108, 92, 231, 0.12); color: var(--accent-light); }
.modal-tag.filter-tag { background: rgba(0, 206, 201, 0.12); color: var(--success); }
.modal-tag.price-tag { background: rgba(253, 203, 110, 0.12); color: var(--warning); font-family: 'Space Mono', monospace; }
.modal-close { position: absolute; top: 16px; right: 16px; width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(0,0,0,0.5); color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

.toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.sort-select { padding: 7px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 12px; font-family: inherit; outline: none; cursor: pointer; }
.sort-select:focus { border-color: var(--accent); }
.toolbar-label { font-size: 12px; color: var(--text-muted); }

.treemap-container { width: 100%; position: relative; border-radius: 12px; overflow: hidden; }
.treemap-node {
  position: absolute; overflow: hidden; border: 1px solid var(--bg-primary); cursor: pointer;
  transition: opacity 0.2s; display: flex; flex-direction: column; align-items: center;
  justify-content: center; text-align: center; padding: 4px;
}
.treemap-node:hover { opacity: 0.8; z-index: 10; }
.treemap-node .tm-label { font-size: 12px; font-weight: 600; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.6); line-height: 1.3; word-break: keep-all; pointer-events: none; }
.treemap-node .tm-count { font-family: 'Space Mono', monospace; font-size: 11px; color: rgba(255,255,255,0.75); text-shadow: 0 1px 3px rgba(0,0,0,0.6); pointer-events: none; }
.treemap-node .tm-icon { width: 32px; height: 32px; object-fit: contain; margin-bottom: 4px; pointer-events: none; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
.treemap-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.treemap-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); cursor: pointer; padding: 4px 10px; border-radius: 6px; transition: background 0.15s; }
.treemap-legend-item:hover { background: var(--bg-hover); }
.treemap-legend-item .dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

/* POSITIONING MAP */
.posmap-wrap { position: relative; user-select: none; height: calc(100vh - 150px); display: flex; flex-direction: column; }
.posmap-toolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; flex-shrink: 0; }
.posmap-toolbar button {
  padding: 5px 12px; border: 1px solid var(--border); background: var(--bg-card);
  color: var(--text-secondary); font-size: 12px; font-family: inherit; border-radius: 6px; cursor: pointer; transition: all 0.15s;
}
.posmap-toolbar button:hover { border-color: var(--accent); color: var(--text-primary); }
.posmap-toolbar .pm-info { font-size: 11px; color: var(--text-muted); font-family: 'Space Mono', monospace; margin-left: auto; }
.pm-size-label { font-size: 11px; color: var(--text-muted); font-family: 'Space Mono', monospace; min-width: 40px; text-align: center; }
.posmap-viewport {
  flex: 1; position: relative; background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 12px; overflow: hidden;
}
.posmap-canvas { position: absolute; top: 0; left: 0; transform-origin: 0 0; }
.posmap-axis { position: absolute; color: var(--text-muted); font-size: 11px; font-weight: 600; letter-spacing: 0.5px; pointer-events: none; z-index: 5; opacity: 0.7; }
.posmap-axis.left { left: 8px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
.posmap-axis.right { right: 8px; top: 50%; transform: translateY(-50%) rotate(90deg); }
.posmap-axis.top { top: 8px; left: 50%; transform: translateX(-50%); }
.posmap-axis.bottom { bottom: 8px; left: 50%; transform: translateX(-50%); }
.posmap-grid-h, .posmap-grid-v { position: absolute; background: var(--border); pointer-events: none; z-index: 1; opacity: 0.5; }
.posmap-grid-h { height: 1px; left: 0; width: 100%; }
.posmap-grid-v { width: 1px; top: 0; height: 100%; }
.posmap-item {
  position: absolute; transform: translate(-50%, -50%); cursor: pointer; z-index: 10;
  transition: opacity 0.2s;
}
.posmap-item:hover { z-index: 50; }
.posmap-item:hover .pi-tip { display: block; }
.posmap-item.dragging { cursor: grabbing; z-index: 100; transition: none; }
.posmap-item.pm-hidden { display: none; }
.posmap-item.pm-selected img { box-shadow: 0 0 0 2px var(--accent), 0 2px 8px rgba(108,92,231,0.4); border-radius: 4px; }
.pm-selbox {
  position: absolute; border: 1px dashed var(--accent); background: rgba(108,92,231,0.08);
  pointer-events: none; z-index: 500;
}
.posmap-item img {
  object-fit: contain !important; border: none !important; background: transparent !important;
  display: block; border-radius: 0 !important; padding: 0 !important;
  transition: width 0.15s, height 0.15s, filter 0.15s;
}
.posmap-item:hover img { filter: brightness(1.2) drop-shadow(0 0 4px var(--accent)); }
.posmap-item .pi-tip {
  display: none; position: absolute; bottom: calc(100% + 4px); left: 50%;
  transform: translateX(-50%) scale(var(--pm-inv-scale, 1)); transform-origin: bottom center;
  background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px;
  padding: 6px 10px; white-space: nowrap; font-size: 11px; color: var(--text-primary);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); pointer-events: none; z-index: 200;
}
.posmap-cat-label {
  position: absolute; transform: translate(-50%, -50%); pointer-events: none; z-index: 3;
  font-size: 11px; font-weight: 700; color: var(--accent-light); opacity: 0.5;
  text-shadow: 0 0 8px var(--bg-card); white-space: nowrap; transition: opacity 0.2s;
}
.posmap-cat-label.pm-hidden { display: none; }

.empty-state { text-align: center; padding: 80px 20px; color: var(--text-muted); }
.empty-state .emoji { font-size: 48px; margin-bottom: 16px; }
.empty-state p { font-size: 15px; }

:root[data-theme="light"] .card:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 0 0 1px var(--accent-glow); }
:root[data-theme="light"] .card { box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
:root[data-theme="light"] .modal { box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
:root[data-theme="light"] .modal-overlay { background: rgba(0,0,0,0.35); }
:root[data-theme="light"] .logo span { color: var(--text-secondary); }

@media (max-width: 900px) { .sidebar { width: 220px; min-width: 220px; } .grid-view { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); } }

/* === Î™®Î∞îÏùº === */
.mobile-filter-btn { display: none; }
.mobile-sidebar-backdrop { display: none; }

@media (max-width: 700px) {
  /* Ìó§Îçî: 2Ï§Ñ Î†àÏù¥ÏïÑÏõÉ */
  .header {
    height: auto; padding: 10px 12px; gap: 8px; flex-wrap: wrap;
  }
  .logo img { height: 18px; }
  .logo span { font-size: 9px; letter-spacing: 2px; }
  .search-box { order: 10; flex-basis: 100%; max-width: 100%; }
  .search-box input { padding: 9px 14px 9px 36px; font-size: 13px; }
  .search-box::before { left: 10px; font-size: 14px; }
  .stats { display: none; }
  .view-modes {
    order: 9; flex-basis: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch;
    gap: 2px; padding: 2px; justify-content: stretch;
  }
  .view-modes::-webkit-scrollbar { display: none; }
  .view-btn { padding: 6px 10px; font-size: 11px; flex: 1; text-align: center; min-width: 0; }
  .theme-toggle { width: 30px; height: 30px; font-size: 14px; }

  /* Î™®Î∞îÏùº ÌïÑÌÑ∞ Î≤ÑÌäº */
  .mobile-filter-btn {
    display: flex; align-items: center; justify-content: center;
    width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--border);
    background: var(--bg-primary); color: var(--text-secondary); font-size: 16px;
    cursor: pointer; flex-shrink: 0;
  }
  .mobile-filter-btn.has-filter { border-color: var(--accent); color: var(--accent-light); background: rgba(108,92,231,0.1); }

  /* ÏÇ¨Ïù¥ÎìúÎ∞î: Ïä¨ÎùºÏù¥Îìú Ïò§Î≤ÑÎ†àÏù¥ */
  .sidebar {
    display: flex; position: fixed; left: -280px; top: 0; bottom: 0; width: 280px; min-width: 280px;
    z-index: 500; transition: left 0.25s ease; box-shadow: none;
  }
  .sidebar.mobile-open { left: 0; box-shadow: 4px 0 24px rgba(0,0,0,0.5); }
  .mobile-sidebar-backdrop {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    z-index: 499; -webkit-tap-highlight-color: transparent;
  }
  .mobile-sidebar-backdrop.show { display: block; }

  /* Ïï± Î∞îÎîî */
  .app-body { height: calc(100vh - auto); height: calc(100dvh - auto); flex-direction: column; }
  .main-content { padding: 12px; }

  /* Ìà¥Î∞î */
  .toolbar { flex-wrap: wrap; gap: 6px; }
  .toolbar-label { font-size: 11px; }
  .sort-select { font-size: 11px; padding: 5px 8px; }
  .size-toggle { margin-left: 0; }
  .size-btn { padding: 5px 10px; font-size: 11px; }
  .e01-toggle-btn { padding: 5px 10px; font-size: 11px; }

  /* Í∑∏Î¶¨Îìú */
  .grid-view { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; }
  .grid-view.large { grid-template-columns: repeat(2, 1fr) !important; gap: 10px; }
  .grid-view.large .card-img img { width: 80%; height: 80%; }
  .grid-view.large .card-info { padding: 10px 12px; }
  .grid-view.large .card-name { font-size: 13px; }

  /* Ïπ¥Îìú */
  .card-info { padding: 8px 10px; }
  .card-name { font-size: 12px; }
  .card-price { font-size: 11px; }
  .card-filter { font-size: 9px; }
  .card-path { font-size: 8px; }

  /* Ïπ¥ÌÖåÍ≥†Î¶¨ Î∑∞ */
  .category-grid { grid-template-columns: repeat(3, 1fr) !important; gap: 8px; }
  .category-grid.large { grid-template-columns: repeat(2, 1fr) !important; gap: 10px; }
  .category-header { gap: 8px; margin-bottom: 10px; padding-bottom: 8px; }
  .category-name { font-size: 15px; }
  .category-count { font-size: 11px; }

  /* Î™®Îã¨: ÌíÄÏä§ÌÅ¨Î¶∞ */
  .modal { width: 100%; max-width: 100%; border-radius: 0; height: 100%; max-height: 100%; display: flex; flex-direction: column; }
  .modal-overlay { align-items: stretch; }
  .modal-img { height: 220px; flex-shrink: 0; }
  .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
  .modal-name { font-size: 18px; }
  .modal-close { top: 12px; right: 12px; width: 36px; height: 36px; font-size: 20px; }
  .modal-tags { gap: 4px; }
  .modal-tag { font-size: 10px; padding: 3px 8px; }
  .modal-desc { font-size: 13px; }

  /* Ìä∏Î¶¨Îßµ */
  .treemap-legend { flex-wrap: wrap; gap: 4px; }

  /* Ìè¨ÏßÄÏÖîÎãùÎßµ */
  .posmap-toolbar { gap: 4px; }
  .posmap-toolbar button { font-size: 11px; padding: 4px 8px; }
}

.e01-dot { position:absolute; top:5px; right:5px; width:8px; height:8px; border-radius:50%;
  background:#e74c3c; box-shadow:0 0 0 1.5px rgba(0,0,0,0.3); pointer-events:none; z-index:10; }
.e01-toggle-btn { padding:6px 14px; border-radius:20px; border:1px solid #e74c3c;
  background:transparent; color:#e74c3c; font-size:12px; font-weight:600;
  cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.e01-toggle-btn.active { background:#e74c3c; color:white; box-shadow:0 2px 8px rgba(231,76,60,0.5); }
.e01-toggle-btn:hover { opacity:0.85; }
.sel-badges { display:flex; flex-wrap:wrap; gap:4px; padding:6px 8px; border-bottom:1px solid var(--border); }
.sel-badge { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:12px;
  font-size:11px; background:var(--accent); color:white; cursor:pointer; transition:opacity 0.15s; }
.sel-badge:hover { opacity:0.75; }
</style>
</head>
<body>

<div class="header">
  <div class="logo"><img src="./InZOI_Logo.png" alt="inZOI"><span>Object Catalog</span></div>
  <div class="search-box"><input type="text" id="searchInput" placeholder="Ïò§Î∏åÏ†ùÌä∏ Í≤ÄÏÉâ (Ïù¥Î¶Ñ, ID, ÏÑ§Î™Ö...)"></div>
  <div class="view-modes">
    <button class="view-btn active" data-view="category">Ïπ¥ÌÖåÍ≥†Î¶¨</button>
    <button class="view-btn" data-view="grid">Í∑∏Î¶¨Îìú</button>
<button class="view-btn" data-view="posmap">Ìè¨ÏßÄÏÖîÎãùÎßµ</button>
    <button class="view-btn" data-view="treemap">Ìä∏Î¶¨Îßµ</button>
  </div>
  <div class="stats" id="stats"><b>3831</b> objects</div>
  <button class="mobile-filter-btn" id="mobileFilterBtn" onclick="toggleMobileSidebar()" title="ÌïÑÌÑ∞">‚ò∞</button>
  <button class="theme-toggle" id="themeToggle" title="Îã§ÌÅ¨/ÎùºÏù¥Ìä∏ ÌÖåÎßà Ï†ÑÌôò">‚òÄÔ∏è</button>
</div>

<div class="app-body">
  <div class="mobile-sidebar-backdrop" id="mobileSidebarBackdrop" onclick="toggleMobileSidebar()"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" onclick="switchSidebarTab('category')">Ïπ¥ÌÖåÍ≥†Î¶¨</button>
      <button class="sidebar-tab" onclick="switchSidebarTab('filter')">ÌïÑÌÑ∞</button>
    </div>
    <div class="sidebar-search"><input type="text" id="filterSearch" placeholder="Í≤ÄÏÉâ..."></div>
    <div class="sidebar-panel active" id="panelCategory">
      <div style="display:flex;justify-content:flex-end;padding:4px 8px 0">
        <button class="lang-toggle ko" id="langToggle" title="ÌïúÍ∏Ä/ÏòÅÏñ¥ Ï†ÑÌôò">KO</button>
      </div>
      <div class="filter-list" id="filterList"></div>
    </div>
    <div class="sidebar-panel" id="panelFilter">
      <div id="filterTagList"></div>
    </div>
  </div>
  <div class="main-content" id="mainContent">
    <div class="toolbar">
      <button id="e01ToggleBtn" class="e01-toggle-btn active" onclick="toggleE01()" title="E01 ÏïÑÏù¥ÌÖú ÌëúÏãú/Ïà®Í∏∞Í∏∞">E01 ON</button>
      <label class="toolbar-label">Ï†ïÎ†¨:</label>
      <select class="sort-select" id="sortSelect">
        <option value="name">Ïù¥Î¶ÑÏàú</option>
        <option value="price-asc">Í∞ÄÍ≤© ÎÇÆÏùÄÏàú</option>
        <option value="price-desc">Í∞ÄÍ≤© ÎÜíÏùÄÏàú</option>
        <option value="id" selected>IDÏàú</option>
        <option value="filter">Ïπ¥ÌÖåÍ≥†Î¶¨Ïàú</option>
      </select>
      <div class="size-toggle">
        <button class="size-btn" data-size="normal" title="Í∏∞Î≥∏ ÌÅ¨Í∏∞">Í∏∞Î≥∏</button>
        <button class="size-btn active" data-size="large" title="2Î∞∞ ÌÅ¨Í∏∞">2Î∞∞</button>
      </div>
    </div>
    <div id="contentArea"></div>
    <div id="loadingIndicator" style="display:none;text-align:center;padding:32px 0;"><div style="color:var(--text-muted);font-size:14px;">Î∂àÎü¨Ïò§Îäî Ï§ë...</div></div>
  </div>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal" style="position:relative;">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-img" id="modalImg"></div>
    <div class="modal-body">
      <div class="modal-name" id="modalName"></div>
      <div class="modal-id"><span id="modalId"></span><button class="copy-btn" onclick="copyId(this)">üìã</button></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div class="modal-tags" id="modalTags"></div>
    </div>
  </div>
</div>


<div id="loginOverlay" style="position:fixed;inset:0;background:var(--bg-primary,#0a0a0f);display:flex;align-items:center;justify-content:center;z-index:10000;">
  <div style="text-align:center;font-family:'Noto Sans KR',sans-serif;">
    <img src="./InZOI_Logo.png" alt="inZOI" style="height:36px;margin-bottom:24px;opacity:0.8;">
    <div style="color:var(--text-muted,#5a5970);font-size:12px;letter-spacing:2px;margin-bottom:32px;">OBJECT CATALOG</div>
    <form id="loginForm" onsubmit="return doLogin(event)">
      <input id="loginPw" type="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" autocomplete="current-password"
        style="width:240px;padding:12px 16px;border:1px solid var(--border,#2a2a3d);border-radius:8px;background:var(--bg-secondary,#12121a);color:var(--text-primary,#e8e6f0);font-size:14px;outline:none;text-align:center;">
      <div id="loginError" style="color:#ff6b6b;font-size:12px;margin-top:10px;height:18px;"></div>
      <button type="submit" style="margin-top:8px;padding:10px 48px;border:1px solid var(--accent,#6c5ce7);background:var(--accent,#6c5ce7);color:#fff;border-radius:8px;font-size:14px;cursor:pointer;transition:opacity 0.2s;"
        onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Enter</button>
    </form>
  </div>
</div>
<div id="loadingOverlay" style="position:fixed;inset:0;background:var(--bg-primary,#0a0a0f);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px;display:none;">
  <div style="width:48px;height:48px;border:3px solid var(--accent-light,#a29bfe);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
  <div style="color:var(--text-secondary,#8b8a9e);font-family:'Noto Sans KR',sans-serif;font-size:14px;">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
  <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
</div>
<script>
// === Ïù∏Ï¶ù ===
function getAuth() {
  try {
    const d = JSON.parse(localStorage.getItem('inzoi_auth') || '{}');
    if (d.token && d.expires > Date.now()) return d.token;
  } catch(e) {}
  return null;
}
function setAuth(token) {
  // 90Ïùº Ïú†ÏßÄ
  localStorage.setItem('inzoi_auth', JSON.stringify({ token, expires: Date.now() + 90*24*60*60*1000 }));
}
async function doLogin(e) {
  e.preventDefault();
  const pw = document.getElementById('loginPw').value;
  const errEl = document.getElementById('loginError');
  errEl.textContent = '';
  try {
    const r = await fetch('/api/auth', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ password: pw })
    });
    const d = await r.json();
    if (d.ok && d.token) {
      setAuth(d.token);
      startApp();
      return false;
    }
    errEl.textContent = d.error || 'Ïù∏Ï¶ù Ïã§Ìå®';
  } catch(err) {
    errEl.textContent = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®';
  }
  return false;
}
async function checkAuth() {
  const token = getAuth();
  if (!token) return false;
  try {
    const r = await fetch('/api/auth', { headers: { 'X-Auth-Token': token } });
    return r.ok;
  } catch(e) { return false; }
}
function startApp() {
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('loadingOverlay').style.display = 'flex';
  loadData();
  onDataReady();
}
// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïù∏Ï¶ù ÌôïÏù∏
checkAuth().then(ok => {
  if (ok) startApp();
  else document.getElementById('loginPw').focus();
});
let ALL_DATA, CAT_HIER, FILTER_KO, OBJ_TAGS, PM_DEFAULT;
let _dataReady;
function loadData() {
  _dataReady = Promise.all([
    fetch('./data/objects.json').then(r => r.json()),
    fetch('./data/meta.json').then(r => r.json()),
    // KV API Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ Ï†ïÏ†Å ÌååÏùº fallback
    fetch('/api/posmap').then(r => r.ok ? r.json() : null).catch(() => null)
      .then(d => d || fetch('./data/posmap_positions.json').then(r => r.json()).catch(() => null))
  ]).then(([objects, meta, posmap]) => {
    ALL_DATA = objects;
    CAT_HIER = meta.catHier;
    FILTER_KO = meta.filterKo;
    OBJ_TAGS = meta.objTags;
    PM_DEFAULT = posmap;
  });
}
const IMG_BASE = "./img/";



function filterLabel(name) {
  if (state.lang === 'ko' && FILTER_KO[name]) return FILTER_KO[name];
  return name;
}

const FILTER_DEFS = {
  "ÌôúÎèô":{Rest:"Ìú¥Ïãù",Clean:"Ï≤≠Í≤∞",Cook:"ÏöîÎ¶¨",Music:"ÏùåÏïÖ",Art:"ÎØ∏Ïà†",Filming:"Ï¥¨ÏòÅ",Fitness:"Ïö¥Îèô",Parenting:"Ïú°ÏïÑ"},
  "Ïù∏Ïõê":{Single:"1Ïù∏Ïö©",Couple:"2Ïù∏Ïö©",Multi:"3Ïù∏Ïö© Ïù¥ÏÉÅ"},
  "Ïä§ÌÉÄÏùº":{Modern:"Î™®Îçò",Natural:"ÎÇ¥Ï∂îÎü¥",Classic:"ÌÅ¥ÎûòÏãù",Vintage:"ÎπàÌã∞ÏßÄ",Scandinavian:"Î∂ÅÏú†ÎüΩ",Bohemian:"Î≥¥Ìó§ÎØ∏Ïïà",Industrial:"Ïù∏ÎçîÏä§Ìä∏Î¶¨Ïñº",Mid_Century_Modern:"ÎØ∏ÎìúÏÑºÏ∂îÎ¶¨ Î™®Îçò",Country:"Ïª®Ìä∏Î¶¨",Tropical:"Ìä∏Î°úÌîºÏª¨"},
  "Ïä§ÌéòÏÖú":{Halloween:"Ìï†Î°úÏúà",WinterFest:"ÌôÄÎ¶¨Îç∞Ïù¥ ÌéòÏä§Ìã∞Î≤å",Hanok:"ÌïúÏò•"}
};

// Reverse lookup: FilterCategory ‚Üí {lv1, lv2}
let FILTER_PATH = {};
function buildFilterPath() {
  FILTER_PATH = {};
  for (const [lv1, lv2map] of Object.entries(CAT_HIER)) {
    for (const [lv2, cats] of Object.entries(lv2map)) {
      for (const c of cats) {
        if (!FILTER_PATH[c]) FILTER_PATH[c] = {lv1, lv2};
      }
    }
  }
}
function getCatPath(filterCat) {
  const p = FILTER_PATH[filterCat];
  if (!p) return filterLabel(filterCat);
  return `${p.lv1} ‚Ä∫ ${p.lv2} ‚Ä∫ ${filterLabel(filterCat)}`;
}




let state = {
  view: 'category', search: '', filterCats: [], filterLv1: '', filterLv2: '',
  sort: 'id', loaded: 60, batchSize: 60, filterSearch: '',
  sizeMode: 'large', lang: 'ko', isLoading: false,
  sidebarTab: 'category', filterTags: [], showE01: true
};


function getFilterCounts(data) {
  const counts = {};
  data.forEach(item => { if (item.filter) counts[item.filter] = (counts[item.filter] || 0) + 1; });
  return Object.entries(counts).sort((a, b) => b[1] - a[1]);
}

function toggleFilterCat(cat, lv1, lv2) {
  state.filterLv1 = lv1; state.filterLv2 = lv2;
  const idx = state.filterCats.indexOf(cat);
  if (idx >= 0) state.filterCats.splice(idx, 1); else state.filterCats.push(cat);
  state.loaded = state.batchSize; render();
}

function toggleE01() {
  state.showE01 = !state.showE01;
  const btn = document.getElementById('e01ToggleBtn');
  if (btn) { btn.textContent = state.showE01 ? 'E01 ON' : 'E01 OFF'; btn.classList.toggle('active', state.showE01); }
  state.loaded = state.batchSize; render();
}

function getFiltered() {
  let result = state.showE01 ? ALL_DATA : ALL_DATA.filter(item => item.source !== 'E01');
  if (state.search) {
    const q = state.search.toLowerCase();
    result = result.filter(item =>
      item.name.toLowerCase().includes(q) || item.id.toLowerCase().includes(q) ||
      item.desc.toLowerCase().includes(q) || item.filter.toLowerCase().includes(q) ||
      item.tags.toLowerCase().includes(q) ||
      (FILTER_KO[item.filter]||'').toLowerCase().includes(q)
    );
  }
  if (state.filterCats.length > 0) {
    result = result.filter(item => state.filterCats.includes(item.filter));
  } else if (state.filterLv2 && state.filterLv1) {
    const lv2cats = CAT_HIER[state.filterLv1] && CAT_HIER[state.filterLv1][state.filterLv2];
    if (lv2cats) { const s = new Set(lv2cats); result = result.filter(item => s.has(item.filter)); }
  } else if (state.filterLv1) {
    const lv2map = CAT_HIER[state.filterLv1];
    if (lv2map) { const s = new Set(); for (const cats of Object.values(lv2map)) cats.forEach(c => s.add(c)); result = result.filter(item => s.has(item.filter)); }
  }
  // Tag filter
  if (state.filterTags.length > 0) {
    result = result.filter(item => {
      const tags = OBJ_TAGS[item.id];
      if (!tags) return false;
      return state.filterTags.every(t => tags.includes(t));
    });
  }
  switch(state.sort) {
    case 'name': result.sort((a,b) => a.name.localeCompare(b.name, 'ko')); break;
    case 'price-asc': result.sort((a,b) => a.price - b.price); break;
    case 'price-desc': result.sort((a,b) => b.price - a.price); break;
    case 'id': result.sort((a,b) => a.id.localeCompare(b.id)); break;
    case 'filter': result.sort((a,b) => a.filter.localeCompare(b.filter) || a.name.localeCompare(b.name, 'ko')); break;
  }
  return result;
}


function imgSrc(icon) { return IMG_BASE + icon + ".PNG"; }
function imgTag(icon) {
  return `<img src="${imgSrc(icon)}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="placeholder" style="display:none">üì¶</div>`;
}

function renderCard(item) {
  const pathHtml = state.search ? `<div class="card-path" title="${getCatPath(item.filter)}">${getCatPath(item.filter)}</div>` : '';
  const e01Dot = item.source === 'E01' ? `<span class="e01-dot"></span>` : '';
  return `<div class="card" onclick="showDetail('${item.id}')">
    <div class="card-img" style="position:relative;">${imgTag(item.icon)}${e01Dot}</div>
    <div class="card-info">
      <div class="card-name" title="${item.name}">${item.name}</div>
      ${pathHtml}
      <div class="card-meta">
        <span class="card-filter" title="${item.filter}">${filterLabel(item.filter)}</span>
        ${item.price ? `<span class="card-price">¬ß${item.price}</span>` : ''}
      </div>
    </div>
  </div>`;
}


function renderGrid(items) {
  const pageItems = items.slice(0, state.loaded);
  const sizeClass = state.sizeMode === 'large' ? ' large' : '';
  if (!pageItems.length) return '<div class="empty-state"><div class="emoji">üîç</div><p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</p></div>';
  return `<div class="grid-view${sizeClass}">${pageItems.map(renderCard).join('')}</div>`;
}


function renderCategory(items) {
  const grouped = {};
  items.forEach(item => { const cat = item.filter || 'Uncategorized'; if (!grouped[cat]) grouped[cat] = []; grouped[cat].push(item); });
  const sorted = Object.entries(grouped).sort((a,b) => b[1].length - a[1].length);
  const sizeClass = state.sizeMode === 'large' ? ' large' : '';
  if (!sorted.length) return '<div class="empty-state"><div class="emoji">üîç</div><p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</p></div>';
  return `<div class="category-view">${sorted.map(([cat, catItems]) => `
    <div class="category-section">
      <div class="category-header">
        <div class="category-name">${filterLabel(cat)}</div>
        <div class="category-count">${catItems.length}</div>
      </div>
      <div class="category-grid${sizeClass}">${catItems.slice(0, 24).map(renderCard).join('')}
        ${catItems.length > 24 ? `<div class="card" style="display:flex;align-items:center;justify-content:center;min-height:180px;cursor:pointer" onclick="state.filterCats=['${cat}'];state.filterLv1='';state.filterLv2='';state.view='grid';state.loaded=state.batchSize;render();document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));document.querySelector('[data-view=grid]').classList.add('active');">
          <div style="text-align:center;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px">+${catItems.length - 24}</div><div style="font-size:12px">Îçî Î≥¥Í∏∞</div></div>
        </div>` : ''}
      </div>
    </div>`).join('')}</div>`;
}

// === TREEMAP ===
const TM_COLORS = ['#6c5ce7','#00cec9','#e17055','#00b894','#fdcb6e','#e84393','#0984e3','#55efc4','#fab1a0','#74b9ff','#a29bfe','#ff7675','#fd79a8','#636e72','#778beb','#f8a5c2','#63cdda','#ea8685','#574b90','#f78fb3'];

function squarify(data, x, y, w, h) {
  if (!data.length || w <= 0 || h <= 0) return [];
  const total = data.reduce((s, d) => s + d.value, 0);
  if (total === 0) return [];
  const rects = [];
  let rem = [...data], cx = x, cy = y, cw = w, ch = h;
  while (rem.length > 0) {
    const wide = cw >= ch, side = wide ? ch : cw;
    const remTotal = rem.reduce((s, d) => s + d.value, 0);
    let row = [rem[0]], rowSum = rem[0].value;
    for (let i = 1; i < rem.length; i++) {
      const testSum = rowSum + rem[i].value;
      const testRow = [...row, rem[i]];
      const rArea = (testSum / remTotal) * cw * ch, rSide = rArea / side;
      let worst1 = 0;
      for (const r of testRow) { const a = (r.value/testSum)*rArea, rr = rSide, rh = a/rr; worst1 = Math.max(worst1, Math.max(rr/rh, rh/rr)); }
      const cArea = (rowSum / remTotal) * cw * ch, cSide = cArea / side;
      let worst2 = 0;
      for (const r of row) { const a = (r.value/rowSum)*cArea, rr = cSide, rh = a/rr; worst2 = Math.max(worst2, Math.max(rr/rh, rh/rr)); }
      if (worst1 <= worst2) { row.push(rem[i]); rowSum = testSum; } else break;
    }
    const rowArea = (rowSum / remTotal) * cw * ch, thick = wide ? rowArea / ch : rowArea / cw;
    let off = 0;
    for (const r of row) {
      const frac = r.value / rowSum, len = frac * side;
      if (wide) rects.push({...r, x: cx, y: cy+off, w: thick, h: len});
      else rects.push({...r, x: cx+off, y: cy, w: len, h: thick});
      off += len;
    }
    rem = rem.slice(row.length);
    if (wide) { cx += thick; cw -= thick; } else { cy += thick; ch -= thick; }
  }
  return rects;
}

function renderTreemap(items) {
  if (!items.length) return '<div class="empty-state"><div class="emoji">üîç</div><p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</p></div>';
  const groups = {};
  items.forEach(item => { const f = item.filter || 'Other'; if (!groups[f]) groups[f] = []; groups[f].push(item); });
  const tmData = Object.entries(groups)
    .map(([name, arr], i) => ({ name, value: arr.length, color: TM_COLORS[i % TM_COLORS.length], icon: arr[0].icon }))
    .sort((a, b) => b.value - a.value);
  const W = 1200, H = 700;
  const rects = squarify(tmData, 0, 0, W, H);
  let legend = '<div class="treemap-legend">';
  tmData.slice(0, 30).forEach(d => {
    legend += `<div class="treemap-legend-item" onclick="state.filterCats=['${d.name}'];state.filterLv1='';state.filterLv2='';state.loaded=state.batchSize;state.view='grid';render();document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));document.querySelector('[data-view=grid]').classList.add('active');">
      <span class="dot" style="background:${d.color}"></span>${filterLabel(d.name)} (${d.value})</div>`;
  });
  if (tmData.length > 30) legend += `<div class="treemap-legend-item" style="color:var(--text-muted)">Ïô∏ ${tmData.length-30}Í∞ú</div>`;
  legend += '</div>';
  let nodes = '';
  rects.forEach(r => {
    const showIcon = r.w > 60 && r.h > 60, showLabel = r.w > 40 && r.h > 30, showCount = r.w > 50 && r.h > 45;
    const fs = Math.min(16, Math.max(9, Math.min(r.w, r.h) / 8));
    nodes += `<div class="treemap-node" style="left:${r.x/W*100}%;top:${r.y/H*100}%;width:${r.w/W*100}%;height:${r.h/H*100}%;background:${r.color};" onclick="state.filterCats=['${r.name}'];state.filterLv1='';state.filterLv2='';state.loaded=state.batchSize;state.view='grid';render();document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));document.querySelector('[data-view=grid]').classList.add('active');" title="${filterLabel(r.name)}: ${r.value}Í∞ú">`;
    if (showIcon) nodes += `<img class="tm-icon" src="${imgSrc(r.icon)}" alt="" onerror="this.style.display='none'">`;
    if (showLabel) nodes += `<span class="tm-label" style="font-size:${fs}px">${filterLabel(r.name)}</span>`;
    if (showCount) nodes += `<span class="tm-count">${r.value}</span>`;
    nodes += '</div>';
  });
  return legend + `<div class="treemap-container" style="padding-bottom:${H/W*100}%">${nodes}</div>`;
}

// === POSITIONING MAP ===
const PM_MOD = ['Î™®Îçò','ÎØ∏ÎãàÎ©Ä','Ïã¨Ìîå','Ïä¨Î¶º','Ïä§Ìã∏','ÌîåÎùºÏä§Ìã±','ÎîîÏßÄÌÑ∏','LED','ÎÑ§Ïò®','Ï≤†Ï†ú','Ïä§ÎßàÌä∏'];
const PM_CLS = ['ÌÅ¥ÎûòÏãù','Ïï§Ìã∞ÌÅ¨','ÎπàÌã∞ÏßÄ','Ï†ÑÌÜµ','ÏõêÎ™©','ÎÇòÎ¨¥','Î™©Ïû¨','ÌïúÏò•','Î†àÌä∏Î°ú','ÎåÄÎ¶¨ÏÑù','Î≤ΩÎèå'];
const PM_GEO = ['ÏÇ¨Í∞Å','ÏßÅÏÑ†','ÌîÑÎ†àÏûÑ','Í≤©Ïûê','Ìå®ÎÑê','Î∏îÎ°ù','ÌÉÄÏùº','ÌîåÎû´','Í∞Å','ÏùºÏûê','Î™®Îìà'];
const PM_ORG = ['ÏõêÌòï','Í≥°ÏÑ†','ÎùºÌÉÑ','ÏûêÏó∞','ÍΩÉ','Îç©Íµ¥','Ïª§Î∏å','Îë•Í∑º','ÏïÑÏπò','Ïò§Î∏åÏ†ú','Ìå®Î∏åÎ¶≠','ÏÜåÌîÑÌä∏'];

let pmPos = {}, pmItemPos = {}, pmIconSize = 28, pmPanX = 0, pmPanY = 0, pmScale = 1;
const pmW = 3000, pmH = 2250;

function pmScore(names) {
  const t = names.join(' ');
  const ms = PM_MOD.reduce((s,k)=>s+(t.split(k).length-1),0);
  const cs = PM_CLS.reduce((s,k)=>s+(t.split(k).length-1),0);
  const gs = PM_GEO.reduce((s,k)=>s+(t.split(k).length-1),0);
  const os = PM_ORG.reduce((s,k)=>s+(t.split(k).length-1),0);
  let x = 0.5; if(ms+cs>0) x = 0.5+((ms-cs)/(ms+cs))*0.35;
  let y = 0.5; if(gs+os>0) y = 0.5-((gs-os)/(gs+os))*0.35;
  return {x,y};
}

// --- Storage ---
function pmLoadLocal() {
  if (PM_DEFAULT) { pmPos=PM_DEFAULT.categories||{}; pmItemPos=PM_DEFAULT.items||{}; return; }
  try { const d=JSON.parse(localStorage.getItem('inzoi_pm3')||'{}'); pmPos=d.categories||{}; pmItemPos=d.items||{}; } catch(e){}
}
function pmSaveLocal() {
  const d = {categories:pmPos, items:pmItemPos};
  if (PM_DEFAULT) { PM_DEFAULT.categories=pmPos; PM_DEFAULT.items=pmItemPos; }
  try { localStorage.setItem('inzoi_pm3', JSON.stringify(d)); } catch(e){}
}
function pmSaveBtn() {
  const d = {categories:pmPos, items:pmItemPos};
  pmSaveLocal();
  fetch('/api/posmap', {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(d)
  }).then(r => {
    if (r.ok) alert('Ï†ÄÏû• ÏôÑÎ£å! Î™®Îì† Î∞©Î¨∏ÏûêÏóêÍ≤å Í≥µÏú†Îê©ÎãàÎã§.');
    else throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò');
  }).catch(() => alert('ÏÑúÎ≤Ñ Ï†ÄÏû• Ïã§Ìå®. Î°úÏª¨ÏóêÎßå Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.'));
}
function pmExportFile() {
  const b=new Blob([JSON.stringify({categories:pmPos, items:pmItemPos},null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='posmap_positions.json'; a.click();
}
function pmImportFile() {
  const inp=document.createElement('input'); inp.type='file'; inp.accept='.json';
  inp.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader();
    r.onload=ev=>{ try{ const d=JSON.parse(ev.target.result);
      pmPos=d.categories||d; pmItemPos=d.items||{}; pmSaveLocal(); render();
    }catch(e){ alert('ÌååÏùº Ïò§Î•ò'); }}; r.readAsText(f); };
  inp.click();
}
function pmResetAll() { if(!confirm('Î™®Îì† ÏúÑÏπòÎ•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return; pmPos={}; pmItemPos={}; pmSaveLocal(); render(); }

// --- Pan / Icon size ---
function pmApplyPan() {
  const c=document.getElementById('pmCanvas');
  if(c) { c.style.transform = `translate(${pmPanX}px,${pmPanY}px) scale(${pmScale})`; document.documentElement.style.setProperty('--pm-inv-scale', 1/pmScale); }
}
function pmSetIconSize(sz) {
  pmIconSize = Math.max(10, Math.min(80, sz));
  document.querySelectorAll('.posmap-item img').forEach(img=>{ img.style.width=pmIconSize+'px'; img.style.height=pmIconSize+'px'; });
  const l=document.getElementById('pmSizeLabel'); if(l) l.textContent=Math.round(pmIconSize)+'px';
}

// --- Filter: show only selected cat, hide others ---
function pmApplyFilter() {
  const cats = state.filterCats;
  document.querySelectorAll('.posmap-item').forEach(el=>{
    el.classList.toggle('pm-hidden', cats.length > 0 && !cats.includes(el.dataset.cat));
  });
  document.querySelectorAll('.posmap-cat-label').forEach(el=>{
    el.classList.toggle('pm-hidden', cats.length > 0 && !cats.includes(el.dataset.cat));
  });
}

// --- Focus view: scale + pan so visible items fill viewport ---
function pmFocusView() {
  const vp = document.getElementById('pmViewport');
  if(!vp) return;
  const vrect = vp.getBoundingClientRect();
  const cats = state.filterCats;
  const selector = cats.length > 0 ? cats.map(ct=>`.posmap-item[data-cat="${ct}"]`).join(',') : '.posmap-item:not(.pm-hidden)';
  const items = document.querySelectorAll(selector);
  if(!items.length) { pmScale=1; pmPanX=0; pmPanY=0; pmApplyPan(); return; }
  let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
  items.forEach(el=>{
    const x=parseFloat(el.style.left), y=parseFloat(el.style.top);
    minX=Math.min(minX,x); minY=Math.min(minY,y); maxX=Math.max(maxX,x); maxY=Math.max(maxY,y);
  });
  const pad = pmIconSize * 2;
  minX-=pad; minY-=pad; maxX+=pad; maxY+=pad;
  const bw=maxX-minX, bh=maxY-minY;
  if(bw<=0||bh<=0) { pmScale=1; pmPanX=0; pmPanY=0; pmApplyPan(); return; }
  const cx=(minX+maxX)/2, cy=(minY+maxY)/2;
  pmScale = Math.min(vrect.width/bw, vrect.height/bh);
  pmPanX = vrect.width/2 - cx*pmScale;
  pmPanY = vrect.height/2 - cy*pmScale;
  pmApplyPan();
}

// --- Render ---
function renderPosmap(allItems) {
  if(!allItems.length) return '<div class="empty-state"><div class="emoji">üîç</div><p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</p></div>';
  pmLoadLocal();
  const groups = {};
  allItems.forEach(item=>{ const f=item.filter||'Other'; if(!groups[f]) groups[f]=[]; groups[f].push(item); });
  const cats = Object.entries(groups);

  let seed=42;
  function rng(){ seed=(seed*16807)%2147483647; return (seed-1)/2147483646; }

  let allDots='', catLabels='';
  cats.forEach(([cat, catItems])=>{
    if(!pmPos[cat]) { const s=pmScore(catItems.map(d=>d.name)); pmPos[cat]={x:s.x,y:s.y}; }
    const bx=pmPos[cat].x*pmW, by=pmPos[cat].y*pmH;
    catLabels += `<div class="posmap-cat-label" data-cat="${cat}" style="left:${bx}px;top:${by-20}px">${filterLabel(cat)}</div>`;
    const spread = Math.min(120, 30 + catItems.length*1.5);
    catItems.forEach((item,i)=>{
      let ix, iy;
      if(pmItemPos[item.id]) { ix=pmItemPos[item.id].x; iy=pmItemPos[item.id].y; }
      else {
        const angle=(i/catItems.length)*Math.PI*2+rng()*0.5, dist=Math.sqrt(rng())*spread;
        ix=bx+Math.cos(angle)*dist; iy=by+Math.sin(angle)*dist;
        pmItemPos[item.id]={x:ix,y:iy};
      }
      allDots += `<div class="posmap-item" style="left:${ix}px;top:${iy}px" data-cat="${cat}" data-id="${item.id}" onmousedown="pmItemDown(event,'${item.id}')">
        <div class="pi-tip">${item.name}<br><span style="color:var(--accent-light)">${filterLabel(cat)}</span></div>
        <img src="${imgSrc(item.icon)}" alt="" loading="lazy" style="width:${pmIconSize}px;height:${pmIconSize}px" onerror="this.style.opacity='0.2'">
      </div>`;
    });
  });

  let grid='';
  grid+=`<div class="posmap-grid-h" style="top:${pmH*0.5}px"></div>`;
  grid+=`<div class="posmap-grid-v" style="left:${pmW*0.5}px"></div>`;
  for(let i=0.25;i<1;i+=0.25){ if(i===0.5) continue;
    grid+=`<div class="posmap-grid-h" style="top:${pmH*i}px;opacity:0.2"></div>`;
    grid+=`<div class="posmap-grid-v" style="left:${pmW*i}px;opacity:0.2"></div>`;
  }

  setTimeout(()=>{ pmApplyFilter(); pmFocusView(); }, 60);

  return `<div class="posmap-wrap">
    <div class="posmap-toolbar">
      <span style="font-size:12px;color:var(--text-muted)">ÏïÑÏù¥ÏΩò:</span>
      <button onclick="pmSetIconSize(pmIconSize/1.3)">‚àí</button>
      <span class="pm-size-label" id="pmSizeLabel">${Math.round(pmIconSize)}px</span>
      <button onclick="pmSetIconSize(pmIconSize*1.3)">+</button>
      <button onclick="pmFocusView()">üîç ÌïúÎààÏóê Î≥¥Í∏∞</button>
      <button onclick="pmSaveBtn()">üíæ Ï†ÄÏû•</button>
      <button onclick="pmExportFile()">üì• ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
      <button onclick="pmImportFile()">üìÇ Î∂àÎü¨Ïò§Í∏∞</button>
      <button onclick="pmResetAll()">üîÑ Ï¥àÍ∏∞Ìôî</button>
      <button onclick="pmClearSelection()">‚úñ ÏÑ†ÌÉùÌï¥Ï†ú</button>
      <span class="pm-info">${allItems.length}Í∞ú ¬∑ ${cats.length}Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨ ¬∑ ÎìúÎûòÍ∑∏=ÏÑ†ÌÉù, Ctrl+Ìú†=Ï§å, Ïö∞ÌÅ¥Î¶≠=Ïù¥Îèô</span>
    </div>
    <div class="posmap-viewport" id="pmViewport">
      <div class="posmap-axis top">ÏßÅÏÑ†Ï†Å Geometric</div>
      <div class="posmap-axis bottom">Ïú†Í∏∞Ï†Å Organic</div>
      <div class="posmap-axis left">ÌÅ¥ÎûòÏãù Classic</div>
      <div class="posmap-axis right">Î™®Îçò Modern</div>
      <div class="posmap-canvas" id="pmCanvas" style="width:${pmW}px;height:${pmH}px;">
        ${grid}${catLabels}${allDots}
      </div>
    </div>
  </div>`;
}

// --- Posmap interaction: click=modal, drag item=move (group if selected), drag empty=rubber band ---
let _pmSelected = new Set(); // selected item IDs
let _pmMode = null; // 'item-drag' | 'group-drag' | 'select-box' | null
let _pmDragSX, _pmDragSY, _pmDragMoved;
// For item/group drag
let _pmDragId = null, _pmDragOX, _pmDragOY, _pmGroupStart = {};
// For select box
let _pmSelBox = null;

function pmClearSelection() {
  _pmSelected.clear();
  document.querySelectorAll('.posmap-item.pm-selected').forEach(el=>el.classList.remove('pm-selected'));
}

function pmItemDown(e, id) {
  if(e.button !== 0) return;
  e.preventDefault(); e.stopPropagation();
  // If modal is open, close it
  if(_modalOpenId) { closeModal(); return; }
  _pmDragSX = e.clientX; _pmDragSY = e.clientY; _pmDragMoved = false;
  _pmDragId = id;
  const el = document.querySelector(`.posmap-item[data-id="${id}"]`);
  if(!el) return;
  _pmDragOX = parseFloat(el.style.left); _pmDragOY = parseFloat(el.style.top);

  if(_pmSelected.has(id)) {
    // Drag all selected items
    _pmMode = 'group-drag';
    _pmGroupStart = {};
    _pmSelected.forEach(sid => {
      const sel = document.querySelector(`.posmap-item[data-id="${sid}"]`);
      if(sel) _pmGroupStart[sid] = { x: parseFloat(sel.style.left), y: parseFloat(sel.style.top) };
    });
  } else {
    // Drag single item
    _pmMode = 'item-drag';
    el.classList.add('dragging');
  }
  document.addEventListener('mousemove', pmDragMove);
  document.addEventListener('mouseup', pmDragEnd);
}

function pmBgDown(e) {
  const vp = document.getElementById('pmViewport');
  if(!vp || e.button !== 0) return;
  // Only trigger on bg, not on items
  if(e.target.closest('.posmap-item')) return;
  if(!vp.contains(e.target)) return;
  // If modal open, close it
  if(_modalOpenId) { closeModal(); return; }
  e.preventDefault();
  _pmDragSX = e.clientX; _pmDragSY = e.clientY; _pmDragMoved = false;
  _pmMode = 'select-box';
  // Clear previous selection unless shift
  if(!e.shiftKey) pmClearSelection();
  // Create selection box element
  _pmSelBox = document.createElement('div');
  _pmSelBox.className = 'pm-selbox';
  vp.appendChild(_pmSelBox);
  document.addEventListener('mousemove', pmDragMove);
  document.addEventListener('mouseup', pmDragEnd);
}

function pmDragMove(e) {
  const dx = (e.clientX - _pmDragSX) / pmScale;
  const dy = (e.clientY - _pmDragSY) / pmScale;
  if(Math.abs(e.clientX - _pmDragSX) > 3 || Math.abs(e.clientY - _pmDragSY) > 3) _pmDragMoved = true;

  if(_pmMode === 'item-drag' && _pmDragId) {
    const el = document.querySelector(`.posmap-item[data-id="${_pmDragId}"]`);
    if(el) { el.style.left = (_pmDragOX + dx) + 'px'; el.style.top = (_pmDragOY + dy) + 'px'; }
  } else if(_pmMode === 'group-drag') {
    _pmSelected.forEach(sid => {
      const start = _pmGroupStart[sid];
      if(!start) return;
      const el = document.querySelector(`.posmap-item[data-id="${sid}"]`);
      if(el) { el.style.left = (start.x + dx) + 'px'; el.style.top = (start.y + dy) + 'px'; }
    });
  } else if(_pmMode === 'select-box' && _pmSelBox) {
    const vp = document.getElementById('pmViewport');
    const vrect = vp.getBoundingClientRect();
    const sx = _pmDragSX - vrect.left, sy = _pmDragSY - vrect.top;
    const cx = e.clientX - vrect.left, cy = e.clientY - vrect.top;
    const left = Math.min(sx, cx), top = Math.min(sy, cy);
    const w = Math.abs(cx - sx), h = Math.abs(cy - sy);
    _pmSelBox.style.left = left + 'px'; _pmSelBox.style.top = top + 'px';
    _pmSelBox.style.width = w + 'px'; _pmSelBox.style.height = h + 'px';
    // Highlight items inside box
    const bx1 = (left - pmPanX) / pmScale, by1 = (top - pmPanY) / pmScale;
    const bx2 = bx1 + w / pmScale, by2 = by1 + h / pmScale;
    document.querySelectorAll('.posmap-item:not(.pm-hidden)').forEach(el => {
      const ix = parseFloat(el.style.left), iy = parseFloat(el.style.top);
      if(ix >= bx1 && ix <= bx2 && iy >= by1 && iy <= by2) {
        el.classList.add('pm-selected'); _pmSelected.add(el.dataset.id);
      } else if(!e.shiftKey) {
        el.classList.remove('pm-selected'); _pmSelected.delete(el.dataset.id);
      }
    });
  }
}

function pmDragEnd(e) {
  if(_pmMode === 'item-drag' && _pmDragId) {
    const el = document.querySelector(`.posmap-item[data-id="${_pmDragId}"]`);
    if(el) {
      el.classList.remove('dragging');
      if(_pmDragMoved) {
        pmItemPos[_pmDragId] = { x: parseFloat(el.style.left), y: parseFloat(el.style.top) };
      } else {
        showDetail(_pmDragId);
      }
    }
  } else if(_pmMode === 'group-drag' && _pmDragMoved) {
    _pmSelected.forEach(sid => {
      const el = document.querySelector(`.posmap-item[data-id="${sid}"]`);
      if(el) pmItemPos[sid] = { x: parseFloat(el.style.left), y: parseFloat(el.style.top) };
    });
  } else if(_pmMode === 'select-box') {
    if(_pmSelBox) { _pmSelBox.remove(); _pmSelBox = null; }
    if(!_pmDragMoved) pmClearSelection(); // click on empty = deselect
  }
  _pmMode = null; _pmDragId = null; _pmGroupStart = {};
  document.removeEventListener('mousemove', pmDragMove);
  document.removeEventListener('mouseup', pmDragEnd);
}

// Register bg mousedown for select-box (runs after item handler via bubbling)
document.addEventListener('mousedown', function(e) {
  const vp = document.getElementById('pmViewport');
  if(!vp || !vp.contains(e.target)) return;
  // Right mouse = pan
  if(e.button === 2) { e.preventDefault(); _pmPan=true; _pmPanSX=e.clientX; _pmPanSY=e.clientY; _pmPanSOX=pmPanX; _pmPanSOY=pmPanY; return; }
  // Left mouse on bg = selection
  if(e.button === 0 && !e.target.closest('.posmap-item')) pmBgDown(e);
});

// --- Mouse wheel: normal=icon size, Ctrl=canvas zoom ---
document.addEventListener('wheel', function(e) {
  const vp=document.getElementById('pmViewport');
  if(!vp || !vp.contains(e.target)) return;
  e.preventDefault();
  if(e.ctrlKey) {
    // Ctrl+wheel: zoom canvas around cursor
    const rect=vp.getBoundingClientRect();
    const mx=e.clientX-rect.left, my=e.clientY-rect.top;
    const factor = e.deltaY < 0 ? 1.15 : 1/1.15;
    const newScale = Math.max(0.05, Math.min(10, pmScale*factor));
    pmPanX = mx - (mx - pmPanX)*(newScale/pmScale);
    pmPanY = my - (my - pmPanY)*(newScale/pmScale);
    pmScale = newScale;
    pmApplyPan();
  } else {
    // Normal wheel: icon size
    pmSetIconSize(e.deltaY < 0 ? pmIconSize*1.15 : pmIconSize/1.15);
  }
}, {passive:false});

// --- Right mouse drag = pan ---
let _pmPan=false, _pmPanSX, _pmPanSY, _pmPanSOX, _pmPanSOY;
document.addEventListener('mousemove', function(e) {
  if(!_pmPan) return;
  pmPanX=_pmPanSOX+(e.clientX-_pmPanSX); pmPanY=_pmPanSOY+(e.clientY-_pmPanSY);
  pmApplyPan();
});
document.addEventListener('mouseup', function(e) { if(e.button===2) _pmPan=false; });
document.addEventListener('auxclick', function(e) {
  const vp=document.getElementById('pmViewport');
  if(vp && vp.contains(e.target) && e.button===2) e.preventDefault();
});
document.addEventListener('contextmenu', function(e) {
  const vp=document.getElementById('pmViewport');
  if(vp && vp.contains(e.target)) e.preventDefault();
});

function updateLoadingIndicator(items) {
  const indicator = document.getElementById('loadingIndicator');
  if (state.view === 'category' || state.view === 'treemap' || state.view === 'posmap' || state.loaded >= items.length) {
    indicator.style.display = 'none';
  } else {
    indicator.style.display = 'block';
    indicator.innerHTML = `<div style="color:var(--text-muted);font-size:13px;font-family:'Space Mono',monospace;">${Math.min(state.loaded, items.length)} / ${items.length}</div>`;
  }
}

function appendMore() {
  if (state.isLoading || state.view === 'category' || state.view === 'treemap' || state.view === 'posmap') return;
  const items = getFiltered();
  if (state.loaded >= items.length) return;
  state.isLoading = true;
  const prevLoaded = state.loaded;
  state.loaded = Math.min(state.loaded + state.batchSize, items.length);
  const newItems = items.slice(prevLoaded, state.loaded);
  const container = document.querySelector('.grid-view');
  if (container) {
    const fragment = document.createDocumentFragment();
    const temp = document.createElement('div');
    temp.innerHTML = newItems.map(renderCard).join('');
    while (temp.firstChild) fragment.appendChild(temp.firstChild);
    container.appendChild(fragment);
  }
  updateLoadingIndicator(items);
  state.isLoading = false;
}


function switchSidebarTab(tab) {
  state.sidebarTab = tab;
  document.querySelectorAll('.sidebar-tab').forEach(b => b.classList.toggle('active', b.textContent.includes(tab === 'category' ? 'Ïπ¥ÌÖåÍ≥†Î¶¨' : 'ÌïÑÌÑ∞')));
  document.getElementById('panelCategory').classList.toggle('active', tab === 'category');
  document.getElementById('panelFilter').classList.toggle('active', tab === 'filter');
}
function toggleMobileSidebar() {
  const sb = document.getElementById('sidebar');
  const bd = document.getElementById('mobileSidebarBackdrop');
  const open = sb.classList.toggle('mobile-open');
  bd.classList.toggle('show', open);
  document.body.style.overflow = open ? 'hidden' : '';
}
function closeMobileSidebar() {
  if (window.innerWidth <= 700) {
    const sb = document.getElementById('sidebar');
    if (sb.classList.contains('mobile-open')) toggleMobileSidebar();
  }
}
// ÏÇ¨Ïù¥ÎìúÎ∞î ÌïÑÌÑ∞ ÌÅ¥Î¶≠ Ïãú Î™®Î∞îÏùºÏóêÏÑú ÏûêÎèô Îã´Í∏∞
document.addEventListener('click', function(e) {
  if (window.innerWidth > 700) return;
  const fi = e.target.closest('.filter-item, .filter-tag-btn');
  if (fi && document.getElementById('sidebar').contains(fi)) {
    setTimeout(closeMobileSidebar, 150);
  }
});

function toggleTag(tag) {
  const idx = state.filterTags.indexOf(tag);
  if (idx >= 0) state.filterTags.splice(idx, 1);
  else state.filterTags.push(tag);
  state.loaded = state.batchSize;
  render();
}

function clearAllTags() {
  state.filterTags = [];
  state.loaded = state.batchSize;
  render();
}

function renderFilterTab() {
  // Count per tag
  const tagCounts = {};
  ALL_DATA.forEach(item => {
    const tags = OBJ_TAGS[item.id];
    if (tags) tags.forEach(t => { tagCounts[t] = (tagCounts[t]||0) + 1; });
  });

  let html = '';
  if (state.filterTags.length > 0) {
    html += `<div style="padding:8px 12px"><button class="filter-tag-btn active" onclick="clearAllTags()" style="font-size:12px">‚úï ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî</button></div>`;
  }

  for (const [group, tags] of Object.entries(FILTER_DEFS)) {
    html += `<div class="filter-group"><div class="filter-group-title">${group}</div><div style="padding:0 8px">`;
    for (const [tag, tagKo] of Object.entries(tags)) {
      const cnt = tagCounts[tag] || 0;
      const isActive = state.filterTags.includes(tag);
      const cls = isActive ? 'active' : (cnt === 0 ? 'disabled' : '');
      const onclick = cnt > 0 || isActive ? `onclick="toggleTag('${tag}')"` : '';
      html += `<button class="filter-tag-btn ${cls}" ${onclick}>${tagKo} <span class="tag-count">${cnt}</span></button>`;
    }
    html += '</div></div>';
  }

  document.getElementById('filterTagList').innerHTML = html;
}

function renderSidebar() {
  // Count items per filterCat
  const fc = {};
  ALL_DATA.forEach(item => { if(item.filter) fc[item.filter] = (fc[item.filter]||0) + 1; });
  const q = state.filterSearch.toLowerCase();
  const noFilter = !state.filterLv1 && !state.filterLv2 && state.filterCats.length === 0;

  let html = `<div class="filter-item ${noFilter ? 'active' : ''}" onclick="state.filterCats=[];state.filterLv1='';state.filterLv2='';state.loaded=state.batchSize;render();">
    <span>Ï†ÑÏ≤¥</span><span class="count">${ALL_DATA.length}</span>
  </div>`;

  for (const [lv1, lv2map] of Object.entries(CAT_HIER)) {
    // Unique count for lv1
    const lv1Filters = new Set();
    for (const cats of Object.values(lv2map)) cats.forEach(c => lv1Filters.add(c));
    const lv1Count = [...lv1Filters].reduce((s,c) => s + (fc[c]||0), 0);
    const lv1Active = state.filterLv1 === lv1 && !state.filterLv2 && state.filterCats.length === 0;
    const lv1Open = state.filterLv1 === lv1;

    if (q) {
      // Search: show matching filters only
      let hasMatch = false;
      let innerHtml = '';
      for (const [lv2, cats] of Object.entries(lv2map)) {
        for (const c of cats) {
          const label = FILTER_KO[c] || c;
          if (c.toLowerCase().includes(q) || label.toLowerCase().includes(q)) {
            hasMatch = true;
            const cnt = fc[c] || 0;
            innerHtml += `<div class="filter-item lv3 ${state.filterCats.includes(c)?'active':''}" onclick="toggleFilterCat('${c}','${lv1}','${lv2}');">
              <span>${label}</span><span class="count">${cnt}</span></div>`;
          }
        }
      }
      if (hasMatch) {
        html += `<div class="filter-item lv1"><span>${lv1}</span><span class="count">${lv1Count}</span></div>`;
        html += innerHtml;
      }
      continue;
    }

    html += `<div class="filter-item lv1 ${lv1Active ? 'active' : ''}" onclick="state.filterLv1=state.filterLv1==='${lv1}'?'':'${lv1}';state.filterLv2='';state.filterCats=[];state.loaded=state.batchSize;render();">
      <span>${lv1Open ? '‚ñº' : '‚ñ∂'} ${lv1}</span><span class="count">${lv1Count}</span>
    </div>`;

    if (lv1Open) {
      for (const [lv2, cats] of Object.entries(lv2map)) {
        const lv2Filters = new Set(cats);
        const lv2Count = [...lv2Filters].reduce((s,c) => s + (fc[c]||0), 0);
        const lv2Active = state.filterLv2 === lv2 && state.filterCats.length === 0;
        const lv2Open = state.filterLv2 === lv2;

        html += `<div class="filter-item lv2 ${lv2Active ? 'active' : ''}" onclick="event.stopPropagation();state.filterLv1='${lv1}';state.filterLv2=state.filterLv2==='${lv2}'?'':'${lv2}';state.filterCats=[];state.loaded=state.batchSize;render();">
          <span>${lv2Open ? '‚ñæ' : '‚ñ∏'} ${lv2}</span><span class="count">${lv2Count}</span>
        </div>`;

        if (lv2Open) {
          for (const c of cats) {
            const cnt = fc[c] || 0;
            if (cnt === 0) continue;
            html += `<div class="filter-item lv3 ${state.filterCats.includes(c)?'active':''}" onclick="event.stopPropagation();toggleFilterCat('${c}','${lv1}','${lv2}');">
              <span>${state.filterCats.includes(c)?'\u2713 ':''}${filterLabel(c)}</span><span class="count">${cnt}</span>
            </div>`;
          }
        }
      }
    }
  }

  document.getElementById('filterList').innerHTML = html;
  let badgeEl = document.getElementById('selBadges');
  if (state.filterCats.length > 1) {
    const badgeHtml = state.filterCats.map(cat => `<span class="sel-badge" onclick="toggleFilterCat('${cat}','${state.filterLv1}','${state.filterLv2}')" title="ÌÅ¥Î¶≠ÏúºÎ°ú Ï†úÍ±∞">‚úï ${filterLabel(cat)}</span>`).join('');
    if (!badgeEl) { badgeEl = document.createElement('div'); badgeEl.id='selBadges'; badgeEl.className='sel-badges'; document.getElementById('filterList').before(badgeEl); }
    badgeEl.innerHTML = badgeHtml; badgeEl.style.display = 'flex';
  } else if (badgeEl) { badgeEl.style.display = 'none'; }
}


function render() {
  const items = getFiltered();
  const area = document.getElementById('contentArea');
  document.getElementById('stats').innerHTML = `<b>${items.length}</b> / ${ALL_DATA.length} objects`;
  switch(state.view) {
    case 'grid': area.innerHTML = renderGrid(items); break;
case 'category': area.innerHTML = renderCategory(items); break;
    case 'treemap': area.innerHTML = renderTreemap(items); break;
    case 'posmap': area.innerHTML = renderPosmap(getFiltered()); break;
  }
  updateLoadingIndicator(items);
  renderSidebar();
  renderFilterTab();
  // Auto-focus posmap on category
  if(state.view === 'posmap') { setTimeout(()=>{ pmApplyFilter(); pmFocusView(); }, 80); }
}

let _modalOpenId = null;
function showDetail(id) {
  if (_modalOpenId === id) { closeModal(); return; }
  const item = ALL_DATA.find(d => d.id === id);
  if (!item) return;
  document.getElementById('modalImg').innerHTML = `<img src="${imgSrc(item.icon)}" alt="" onerror="this.outerHTML='<div style=\'font-size:64px;opacity:0.2\'>üì¶</div>'">`;
  document.getElementById('modalName').textContent = item.name;
  document.getElementById('modalId').textContent = item.id;
  document.getElementById('modalDesc').textContent = item.desc || 'ÏÑ§Î™Ö ÏóÜÏùå';
  let tags = '';
  if (item.filter) tags += `<span class="modal-tag filter-tag">${getCatPath(item.filter)}</span>`;
  if (item.category) tags += `<span class="modal-tag">${item.category}</span>`;
  if (item.tags) tags += `<span class="modal-tag">${item.tags}</span>`;
  if (item.price) tags += `<span class="modal-tag price-tag">¬ß${item.price}</span>`;
  document.getElementById('modalTags').innerHTML = tags;
  document.getElementById('modal').classList.add('show');
  _modalOpenId = id;
}

function closeModal() { document.getElementById('modal').classList.remove('show'); _modalOpenId=null; }
function copyId(btn) {
  const id = document.getElementById('modalId').textContent;
  navigator.clipboard.writeText(id).then(()=>{ btn.textContent='‚úì'; btn.classList.add('copied'); setTimeout(()=>{ btn.textContent='üìã'; btn.classList.remove('copied'); }, 1500); });
}

// === Events ===
document.getElementById('searchInput').addEventListener('input', e => {
  state.search = e.target.value; state.loaded = state.batchSize; state.filterCats = []; state.filterLv1=''; state.filterLv2=''; render();
});
document.getElementById('filterSearch').addEventListener('input', e => {
  state.filterSearch = e.target.value; renderSidebar();
});
document.getElementById('sortSelect').addEventListener('change', e => {
  state.sort = e.target.value; state.loaded = state.batchSize; render();
});
document.getElementById('langToggle').addEventListener('click', () => {
  state.lang = state.lang === 'en' ? 'ko' : 'en';
  const btn = document.getElementById('langToggle');
  btn.textContent = state.lang === 'en' ? 'EN' : 'KO';
  btn.classList.toggle('ko', state.lang === 'ko');
  render();
});
document.getElementById('themeToggle').addEventListener('click', () => {
  const root = document.documentElement;
  const isDark = root.getAttribute('data-theme') !== 'light';
  root.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
});
document.querySelectorAll('.size-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); state.sizeMode = btn.dataset.size; render();
  });
});
document.querySelectorAll('.view-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); state.view = btn.dataset.view; state.loaded = state.batchSize;
    render(); document.getElementById('mainContent').scrollTop = 0;
  });
});
document.getElementById('mainContent').addEventListener('scroll', function() {
  if (this.scrollTop + this.clientHeight >= this.scrollHeight - 400) appendMore();
});
document.getElementById('modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
// Click on empty area in any view closes modal
document.getElementById('mainContent').addEventListener('click', function(e) {
  if(_modalOpenId && !e.target.closest('.card, .posmap-item, .modal')) closeModal();
});

// _dataReadyÎäî loadData() Ìò∏Ï∂ú ÌõÑ ÏÑ§Ï†ïÎê® ‚Üí startApp()ÏóêÏÑú Ï≤òÎ¶¨
function onDataReady() {
  if (!_dataReady) return;
  _dataReady.then(() => {
    buildFilterPath();
    document.getElementById('loadingOverlay').remove();
    render();
  }).catch(err => {
    console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:', err);
    document.getElementById('loadingOverlay').innerHTML =
      '<div style="color:#ff6b6b;font-family:sans-serif;text-align:center;padding:20px;">'
      + '<div style="font-size:18px;margin-bottom:8px;">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®</div>'
      + '<div style="font-size:13px;color:#8b8a9e;">' + err.message + '</div>'
      + '<button onclick="location.reload()" style="margin-top:16px;padding:8px 24px;border:1px solid #6c5ce7;background:none;color:#a29bfe;border-radius:6px;cursor:pointer;">ÏÉàÎ°úÍ≥†Ïπ®</button>'
      + '</div>';
  });
}
</script>
</body>
</html>